name: Cheese App - Build and Release

on: push

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required for GitHub releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet packages
      run: nuget restore cheese-app/cheese-app.sln

    - name: Build solution
      run: msbuild cheese-app/cheese-app.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Package application
      run: |
        $packageDir = "package"                                                                                       
        New-Item -ItemType Directory -Path $packageDir -Force                                                         
        
        # Copy bin directory                                                                                          
        Copy-Item -Path "cheese-app/bin" -Destination "$packageDir/bin" -Recurse -Force                               
        
        # Copy web application files                                                                                  
        Copy-Item -Path "cheese-app/Global.asax" -Destination $packageDir -Force                                      
        Copy-Item -Path "cheese-app/Web.config" -Destination $packageDir -Force                                       
        
        # Copy directories if they exist                                                                              
        if (Test-Path "cheese-app/Views") {                                                                           
            Copy-Item -Path "cheese-app/Views" -Destination "$packageDir/Views" -Recurse -Force                       
        }                                                                                                             
        if (Test-Path "cheese-app/Content") {                                                                         
            Copy-Item -Path "cheese-app/Content" -Destination "$packageDir/Content" -Recurse -Force                   
        }                                                                                                             
        if (Test-Path "cheese-app/Scripts") {                                                                         
            Copy-Item -Path "cheese-app/Scripts" -Destination "$packageDir/Scripts" -Recurse -Force                   
        }                                                                                                             
        if (Test-Path "cheese-app/favicon.ico") {                                                                     
            Copy-Item -Path "cheese-app/favicon.ico" -Destination $packageDir -Force                                  
        }                                                                                                             
        
        # Create the zip archive                                                                                      
        Compress-Archive -Path "$packageDir/*" -DestinationPath "cheese-app-build.zip" -Force
      shell: powershell

    - name: Upload release asset
      uses: softprops/action-gh-release@v2
      if: github.ref_type == 'tag'
      with:
        files: cheese-app-build.zip
